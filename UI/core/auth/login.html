<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Đăng nhập - SmartClinic.AI</title>
        <link
            rel="icon"
            type="image/x-icon"
            href="../../static/home/images/logoicon.webp"
        />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: "#3b82f6",
                            secondary: "#64748b",
                            success: "#10b981",
                            warning: "#f59e0b",
                            danger: "#ef4444",
                            info: "#06b6d4",
                        },
                    },
                },
            };
        </script>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap");

            :root {
                --primary-color: #3b82f6;
                --secondary-color: #64748b;
                --success-color: #10b981;
                --warning-color: #f59e0b;
                --danger-color: #ef4444;
                --info-color: #06b6d4;
                --light-color: #f8fafc;
                --dark-color: #1e293b;
            }

            body {
                font-family: "Roboto", sans-serif;
                background-color: var(--light-color);
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .login-container {
                max-width: 450px;
                margin: 30px auto;
            }

            .auth-card {
                border: none;
                border-radius: 1rem;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                background: white;
            }

            .auth-header {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                padding: 2rem;
                text-align: center;
                color: white;
            }

            .auth-form {
                padding: 2rem;
            }

            .form-control {
                border-radius: 0.5rem;
                padding: 0.75rem 1rem;
                border: 1px solid #e2e8f0;
                transition: all 0.3s;
            }

            .form-control:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
            }

            .btn-auth {
                border-radius: 0.5rem;
                padding: 0.75rem 1rem;
                font-weight: 500;
                transition: all 0.3s;
            }

            .form-floating label {
                padding-left: 1rem;
            }

            .alert-float {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1050;
                min-width: 300px;
                border-left: 4px solid;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
                display: none;
            }

            .alert-float.alert-success {
                border-left-color: var(--success-color);
            }

            .alert-float.alert-danger {
                border-left-color: var(--danger-color);
            }
        </style>
    </head>

    <body>
        <!-- Nhúng topbar mới -->
        <!--#include file="../../static/utils/home/topbar.html" -->

        <main class="flex-grow-1 d-flex align-items-center py-5">
            <div class="container login-container py-3 w-50">
                <div class="auth-card">
                    <div class="auth-header">
                        <img
                            src="../../static/home/images/logoicon.webp"
                            alt="SmartClinic Logo"
                            width="80"
                            height="80"
                            class="mb-4"
                        />
                        <h3 class="fw-bold mb-2">
                            Đăng nhập vào SmartClinic.AI
                        </h3>
                        <p class="text-white-50 mb-0">
                            Vui lòng đăng nhập để tiếp tục trải nghiệm các dịch
                            vụ của chúng tôi
                        </p>
                    </div>
                    <div class="auth-form">
                        <form id="loginForm">
                            <div
                                class="alert alert-danger mb-4 d-none"
                                id="loginError"
                            >
                                Email hoặc mật khẩu không chính xác. Vui lòng
                                thử lại!
                            </div>

                            <div class="form-floating mb-4">
                                <input
                                    type="email"
                                    class="form-control"
                                    id="email"
                                    placeholder="Địa chỉ email"
                                    required
                                />
                                <label for="email">Địa chỉ email</label>
                            </div>
                            <div class="form-floating mb-4">
                                <input
                                    type="password"
                                    class="form-control"
                                    id="password"
                                    placeholder="Mật khẩu"
                                    required
                                />
                                <label for="password">Mật khẩu</label>
                            </div>
                            <div
                                class="d-flex justify-content-between align-items-center mb-4"
                            >
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        id="rememberMe"
                                    />
                                    <label
                                        class="form-check-label text-secondary"
                                        for="rememberMe"
                                    >
                                        Ghi nhớ đăng nhập
                                    </label>
                                </div>
                                <a
                                    href="#"
                                    class="text-primary fw-medium text-decoration-none"
                                >
                                    Quên mật khẩu?
                                </a>
                            </div>
                            <button
                                type="submit"
                                class="btn btn-primary btn-auth w-100 mb-4"
                                id="loginButton"
                            >
                                <i class="fas fa-sign-in-alt me-2"></i> Đăng
                                nhập
                            </button>
                            <div class="text-center">
                                <p class="text-secondary">
                                    Chưa có tài khoản?
                                    <a
                                        href="register.html"
                                        class="text-primary fw-medium text-decoration-none"
                                    >
                                        Đăng ký ngay
                                    </a>
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>

        <!-- Thông báo nổi -->
        <div class="alert alert-float alert-success" id="alertSuccess">
            <i class="fas fa-check-circle me-2"></i>
            <span id="alertSuccessMessage">Đăng nhập thành công!</span>
        </div>
        <div class="alert alert-float alert-danger" id="alertDanger">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span id="alertDangerMessage">Đã có lỗi xảy ra!</span>
        </div>

        <!-- Nhúng footer mới -->
        <!--#include file="../../static/utils/home/footer.html" -->

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const loginForm = document.getElementById("loginForm");
                const loginError = document.getElementById("loginError");
                const loginButton = document.getElementById("loginButton");
                const alertSuccess = document.getElementById("alertSuccess");
                const alertDanger = document.getElementById("alertDanger");
                const alertSuccessMessage = document.getElementById(
                    "alertSuccessMessage"
                );
                const alertDangerMessage =
                    document.getElementById("alertDangerMessage");

                // Function to show alert
                function showAlert(element, message, duration = 3000) {
                    if (message) {
                        element.querySelector("span").textContent = message;
                    }
                    element.style.display = "block";
                    setTimeout(() => {
                        element.style.display = "none";
                    }, duration);
                }

                // Login form submission
                loginForm.addEventListener("submit", function (e) {
                    e.preventDefault();

                    const email = document.getElementById("email").value;
                    const password = document.getElementById("password").value;

                    // Disable button and show loading
                    loginButton.disabled = true;
                    loginButton.innerHTML =
                        '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Đang xử lý...';
                    loginError.classList.add("d-none");

                    // Call API to login
                    fetch("http://localhost:8000/auth/login", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            accept: "application/json",
                        },
                        body: JSON.stringify({
                            email: email,
                            password: password,
                        }),
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error("Đăng nhập thất bại");
                            }
                            return response.json();
                        })
                        .then((data) => {
                            // Store token and user info in localStorage
                            localStorage.setItem(
                                "accessToken",
                                data.access_token
                            );
                            localStorage.setItem("tokenType", data.token_type);

                            // Decode the JWT token to get user info
                            const base64Url = data.access_token.split(".")[1];
                            const base64 = base64Url
                                .replace(/-/g, "+")
                                .replace(/_/g, "/");
                            const jsonPayload = decodeURIComponent(
                                atob(base64)
                                    .split("")
                                    .map(function (c) {
                                        return (
                                            "%" +
                                            (
                                                "00" +
                                                c.charCodeAt(0).toString(16)
                                            ).slice(-2)
                                        );
                                    })
                                    .join("")
                            );

                            const userInfo = JSON.parse(jsonPayload);
                            localStorage.setItem(
                                "userInfo",
                                JSON.stringify({
                                    userId: userInfo.user_id,
                                    userName: userInfo.user_name,
                                    email: userInfo.email,
                                    role: userInfo.role,
                                })
                            );

                            showAlert(
                                alertSuccess,
                                "Đăng nhập thành công! Đang chuyển hướng..."
                            );

                            // Redirect based on role
                            setTimeout(() => {
                                if (userInfo.role === "admin") {
                                    window.location.href =
                                        "/core/admin/index.html";
                                } else {
                                    window.location.href = "/home/main.html";
                                }
                            }, 1500);
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                            loginError.classList.remove("d-none");
                            showAlert(
                                alertDanger,
                                "Đăng nhập thất bại. Vui lòng kiểm tra lại thông tin đăng nhập."
                            );
                        })
                        .finally(() => {
                            // Re-enable button
                            loginButton.disabled = false;
                            loginButton.innerHTML =
                                '<i class="fas fa-sign-in-alt me-2"></i> Đăng nhập';
                        });
                });
            });
        </script>
    </body>
</html>
