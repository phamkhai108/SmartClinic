<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chatbot Y Tế</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js"></script>
        <style>
            .chat-height {
                height: calc(100vh - 200px);
            }
        </style>
    </head>
    <body class="bg-light">
        <div class="container mx-auto py-4 px-2">
            <div class="card shadow-sm">
                <!-- Header -->
                <div class="card-header bg-primary text-white p-3">
                    <div
                        class="d-flex align-items-center justify-content-between"
                    >
                        <div class="d-flex align-items-center">
                            <i class="fas fa-robot me-2"></i>
                            <h5 class="mb-0">Chatbot Y Tế</h5>
                        </div>
                        <button
                            id="clear-session"
                            class="btn btn-sm btn-outline-light"
                        >
                            <i class="fas fa-trash me-1"></i> Xóa phiên
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="card-body p-0">
                    <div
                        id="chat-messages"
                        class="p-3 overflow-auto chat-height"
                    >
                        <!-- Messages will be added here -->
                        <div class="d-flex mb-3">
                            <div
                                class="bg-info bg-opacity-10 p-3 rounded-3 shadow-sm"
                                style="max-width: 80%"
                            >
                                <p class="mb-0">
                                    Xin chào! Tôi là trợ lý y tế ảo. Tôi có thể
                                    giúp gì cho bạn hôm nay?
                                </p>
                                <small class="text-muted">14:30</small>
                            </div>
                        </div>
                    </div>

                    <!-- Typing indicator - Sẽ được thêm vào qua JavaScript khi cần -->
                </div>

                <!-- Chat Input -->
                <div class="card-footer bg-white p-3">
                    <form id="chat-form" class="d-flex">
                        <input
                            type="text"
                            id="user-input"
                            class="form-control rounded-pill me-2"
                            placeholder="Nhập tin nhắn của bạn..."
                        />
                        <button
                            type="submit"
                            class="btn btn-primary rounded-circle"
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Function to generate a random ID
            function generateRandomId(prefix) {
                return prefix + Math.random().toString(36).substring(2, 9);
            }

            // Get or create user ID and session ID
            function getOrCreateId(key, prefix) {
                // Try to get from localStorage
                let id = localStorage.getItem(key);

                // If not found, create a new one and store it
                if (!id) {
                    id = generateRandomId(prefix);
                    localStorage.setItem(key, id);
                }

                return id;
            }

            // Global variables
            const userId = getOrCreateId("medical_chatbot_user_id", "user-");
            const sessionId = getOrCreateId(
                "medical_chatbot_session_id",
                "session-"
            );
            const chatMessages = document.getElementById("chat-messages");
            const chatForm = document.getElementById("chat-form");
            const userInput = document.getElementById("user-input");
            const clearSessionBtn = document.getElementById("clear-session");

            // Initialize
            userInput.focus();
            loadChatHistory();

            // Event listeners
            chatForm.addEventListener("submit", sendMessage);
            clearSessionBtn.addEventListener("click", clearSession);

            // Function to load chat history
            function loadChatHistory() {
                // Try to get chat history from localStorage
                const chatHistory = localStorage.getItem(
                    "medical_chatbot_history"
                );

                if (chatHistory) {
                    try {
                        // Parse the stored history
                        const historyArray = JSON.parse(chatHistory);

                        // Clear the default welcome message
                        chatMessages.innerHTML = "";

                        // Add each message from history
                        historyArray.forEach((item) => {
                            addMessage(
                                item.content,
                                item.role,
                                item.time,
                                false
                            );
                        });

                        // Scroll to bottom
                        scrollToBottom();
                    } catch (error) {
                        console.error("Error loading chat history:", error);
                        // If error, clear history
                        localStorage.removeItem("medical_chatbot_history");
                    }
                }
            }

            // Function to save message to history
            function saveMessageToHistory(content, role, time) {
                // Get existing history
                let historyArray = [];
                const chatHistory = localStorage.getItem(
                    "medical_chatbot_history"
                );

                if (chatHistory) {
                    try {
                        historyArray = JSON.parse(chatHistory);
                    } catch (error) {
                        console.error("Error parsing chat history:", error);
                    }
                }

                // Add new message
                historyArray.push({
                    content: content,
                    role: role,
                    time: time,
                });

                // Save back to localStorage
                localStorage.setItem(
                    "medical_chatbot_history",
                    JSON.stringify(historyArray)
                );
            }

            // Function to clear session
            function clearSession() {
                if (
                    confirm("Bạn có chắc chắn muốn xóa toàn bộ phiên chat này?")
                ) {
                    // Generate new session ID
                    const newSessionId = generateRandomId("session-");
                    localStorage.setItem(
                        "medical_chatbot_session_id",
                        newSessionId
                    );

                    // Clear chat history
                    localStorage.removeItem("medical_chatbot_history");

                    // Reload page
                    window.location.reload();
                }
            }

            // Function to send message
            async function sendMessage(e) {
                e.preventDefault();

                const message = userInput.value.trim();
                if (!message) return;

                // Clear input
                userInput.value = "";

                // Get current time
                const time = new Date().toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                });

                // Add user message to chat
                addMessage(message, "user", time);

                // Show typing indicator - Tạo và thêm vào DOM
                const typingIndicator = showTypingIndicator();

                // Scroll to bottom
                scrollToBottom();

                try {
                    // Send request to API
                    const response = await callChatAPI(message);

                    // Hide typing indicator TRƯỚC khi hiển thị phản hồi
                    if (typingIndicator) {
                        typingIndicator.remove(); // Xóa hoàn toàn khỏi DOM
                    }

                    // Add bot response to chat
                    if (
                        response &&
                        response.choice &&
                        response.choice.messages
                    ) {
                        const botMessage = response.choice.messages.find(
                            (msg) => msg.role === "assistant"
                        );
                        if (botMessage) {
                            // Use time from API response if available
                            const responseTime = response.time_at
                                ? new Date(response.time_at).toLocaleTimeString(
                                      [],
                                      { hour: "2-digit", minute: "2-digit" }
                                  )
                                : time;

                            addMessage(botMessage.content, "bot", responseTime);
                        }
                    }
                } catch (error) {
                    console.error("Error:", error);
                    // Hide typing indicator in case of error too
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    addMessage(
                        "Xin lỗi, đã xảy ra lỗi khi xử lý yêu cầu của bạn.",
                        "bot",
                        time
                    );
                }

                // Scroll to bottom again after adding bot message
                scrollToBottom();
            }

            // Function to show typing indicator
            function showTypingIndicator() {
                const typingIndicator = document.createElement("div");
                typingIndicator.id = "typing-indicator";
                typingIndicator.className = "d-flex ms-2 mb-3";
                typingIndicator.innerHTML = `
                <div class="bg-info bg-opacity-10 p-2 rounded-3">
                    <div class="d-flex align-items-center">
                        <small class="text-muted me-2">Đang nhập</small>
                        <div class="spinner-grow spinner-grow-sm text-info" role="status" style="width: 0.5rem; height: 0.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="spinner-grow spinner-grow-sm text-info ms-1" role="status" style="width: 0.5rem; height: 0.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="spinner-grow spinner-grow-sm text-info ms-1" role="status" style="width: 0.5rem; height: 0.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            `;
                chatMessages.appendChild(typingIndicator);
                return typingIndicator;
            }

            // Function to add message to chat
            function addMessage(content, role, time, saveToHistory = true) {
                const messageDiv = document.createElement("div");
                messageDiv.className = "d-flex mb-3";

                if (role === "user") {
                    messageDiv.classList.add("justify-content-end");
                    messageDiv.innerHTML = `
                    <div class="bg-primary bg-opacity-10 p-3 rounded-3 shadow-sm" style="max-width: 80%;">
                        <p class="mb-0">${content}</p>
                        <small class="text-muted d-block text-end">${time}</small>
                    </div>
                `;
                } else {
                    messageDiv.innerHTML = `
                    <div class="bg-info bg-opacity-10 p-3 rounded-3 shadow-sm" style="max-width: 80%;">
                        <p class="mb-0">${content}</p>
                        <small class="text-muted">${time}</small>
                    </div>
                `;
                }

                chatMessages.appendChild(messageDiv);

                // Save to history if needed
                if (saveToHistory) {
                    saveMessageToHistory(content, role, time);
                }
            }

            // Function to call chat API
            async function callChatAPI(message) {
                const response = await fetch(
                    "http://localhost:8000/chat_all/chat",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            accept: "application/json",
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            session_id: sessionId,
                            messages: [
                                {
                                    role: "user",
                                    content: message,
                                },
                            ],
                        }),
                    }
                );

                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }

                return await response.json();
            }

            // Function to scroll chat to bottom
            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        </script>
    </body>
</html>
