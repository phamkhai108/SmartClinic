<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chatbot Y Tế | SmartClinic.AI</title>
        <link
            href="../../static/bootstrap-5.3.6/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="../../static/fontawesome-free-6.7.2-web/css/all.min.css"
            rel="stylesheet"
        />
        <script src="../../static/tailwindcss.js"></script>
        <!-- Thêm thư viện marked để xử lý markdown -->
        <script src="../../static\marked.min.js"></script>
        <!-- Thêm highlight.js cho code highlighting -->
        <link href="../../static/github.min.css" rel="stylesheet" />
        <script src="../..\static\highlight.min.js"></script>
        <!-- Auth Guard -->
        <script src="../auth/auth-guard.js"></script>
        <style>
            /* Sử dụng CSS tối thiểu, phần lớn dựa vào Bootstrap và Tailwind */
            .chat-height {
                height: calc(100vh - 200px);
            }

            /* Sidebar cho lịch sử hội thoại */
            .sidebar {
                width: 300px;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1030;
                transition: all 0.3s ease;
                background: #f8f9fa;
            }

            .sidebar.collapsed {
                width: 60px;
            }

            .sidebar.collapsed .conversation-title,
            .sidebar.collapsed #empty-conversations,
            .sidebar.collapsed #new-chat-btn span {
                display: none;
            }

            .sidebar.collapsed #conversation-list li {
                padding: 10px;
            }

            .sidebar.collapsed #conversation-list .conversation-info {
                display: none;
            }

            /* Main content adjustments */
            #main-content {
                transition: all 0.3s ease;
                margin-left: 300px;
                min-height: 100vh;
                background: #f8f9fa;
            }

            #main-content.expanded {
                margin-left: 60px;
            }

            @media (max-width: 768px) {
                #main-content {
                    margin-left: 0;
                }
                .sidebar {
                    transform: translateX(-100%);
                }
                .sidebar.show {
                    transform: translateX(0);
                    width: 300px;
                }
            }

            @media (max-width: 768px) {
                .sidebar {
                    transform: translateX(-100%);
                }
                .sidebar.show {
                    transform: translateX(0);
                }
                #main-content {
                    margin-left: 0 !important;
                }
            }

            .conversation-item.active {
                background-color: rgba(59, 130, 246, 0.1);
                border-left: 3px solid #3b82f6;
            }

            /* Thêm overlay cho mobile */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1020;
            }

            @media (max-width: 768px) {
                .sidebar-overlay.show {
                    display: block;
                }
            }

            /* CSS cho markdown content */
            .markdown-content pre {
                background-color: #f6f8fa;
                padding: 0.75rem;
                border-radius: 0.5rem;
                overflow-x: auto;
                margin-bottom: 1rem;
            }

            .markdown-content code {
                font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo,
                    monospace;
                font-size: 0.875rem;
                background-color: rgba(175, 184, 193, 0.2);
                padding: 0.2em 0.4em;
                border-radius: 0.25rem;
            }

            .markdown-content pre code {
                background-color: transparent;
                padding: 0;
            }

            /* Hiệu ứng skeleton loading */
            .skeleton {
                animation: skeleton-loading 1s linear infinite alternate;
            }

            @keyframes skeleton-loading {
                0% {
                    background-color: rgba(206, 212, 218, 0.2);
                }
                100% {
                    background-color: rgba(206, 212, 218, 0.4);
                }
            }

            .skeleton-item {
                height: 60px;
                margin-bottom: 10px;
                border-radius: 4px;
            }

            /* Enhanced sidebar styles */
            .sidebar {
                width: 300px;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1030;
                transition: all 0.3s ease;
                background: #ffffff;
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            }

            .sidebar.collapsed {
                width: 50px;
            }

            .sidebar-header {
                background: #0d6efd;
                color: white;
                padding: 1rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                height: 60px;
            }

            .conversation-list-container {
                height: calc(100vh - 120px);
                overflow-y: auto;
            }

            .sidebar.collapsed .conversation-title,
            .sidebar.collapsed .new-chat-text,
            .sidebar.collapsed .conversation-preview {
                display: none;
            }

            .sidebar.collapsed #new-chat-btn {
                width: 40px;
                padding: 8px;
                justify-content: center;
            }

            .sidebar.collapsed #conversation-list li {
                padding: 15px 10px;
                text-align: center;
            }

            .conversation-item {
                padding: 12px 16px;
                border-bottom: 1px solid #e9ecef;
                transition: all 0.2s ease;
            }

            .conversation-item:hover {
                background-color: #f8f9fa;
            }

            .conversation-item.active {
                background-color: #e7f1ff;
                border-left: 3px solid #0d6efd;
            }

            #new-chat-btn {
                background: #0d6efd;
                color: white;
                border: none;
                padding: 10px 16px;
                width: 100%;
                text-align: left;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s ease;
            }

            #new-chat-btn:hover {
                background: #0b5ed7;
            }

            .toggle-btn {
                background: transparent;
                border: none;
                color: white;
                width: 32px;
                height: 32px;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .toggle-btn:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            /* Conversation item styling */
            .conversation-preview {
                max-width: 230px;
            }

            .conversation-title {
                font-weight: 500;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .conversation-time {
                font-size: 0.75rem;
                color: #6c757d;
            }

            /* Updated chat container styles */
            .chat-container {
                max-width: 1200px;
                margin: 0 auto;
                height: 100vh;
                padding: 1rem;
                display: flex;
                align-items: center;
            }

            .chat-card {
                display: flex;
                flex-direction: column;
                height: 95vh; /* Increased height to make it more prominent */
                width: 100%;
                background: white;
                border-radius: 0.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .chat-header {
                flex-shrink: 0;
                padding: 1.5rem !important; /* Increased padding */
                background: linear-gradient(
                    135deg,
                    #0d6efd,
                    #0b5ed7
                ) !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .chat-header h5 {
                font-size: 1.25rem !important;
                letter-spacing: 0.5px;
            }

            .chat-messages-container {
                flex: 1;
                overflow-y: auto;
                min-height: 0;
                padding: 1.5rem;
                background-color: #f8f9fa;
                position: relative;
            }

            .chat-footer {
                flex-shrink: 0;
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                background: white;
                padding: 1.25rem;
                position: relative;
            }

            .chat-footer::before {
                content: "";
                position: absolute;
                top: -10px;
                left: 0;
                right: 0;
                height: 10px;
                background: linear-gradient(
                    to top,
                    rgba(0, 0, 0, 0.05),
                    transparent
                );
            }

            /* Enhanced input styles */
            #user-input {
                padding: 0.75rem 1.25rem;
                font-size: 1rem;
                border-color: #e9ecef;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            #user-input:focus {
                border-color: #0d6efd;
                box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
            }

            .btn-send {
                width: 45px;
                height: 45px;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #0d6efd, #0b5ed7);
                border: none;
                box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
            }

            .btn-send:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 6px rgba(13, 110, 253, 0.4);
            }
        </style>
    </head>
    <body class="bg-light">
        <!-- Add overlay div -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <!-- Update sidebar structure -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="conversation-title d-flex align-items-center">
                    <i class="fas fa-comments me-2"></i>
                    <span>Lịch sử trò chuyện</span>
                </div>
                <button id="toggle-sidebar" class="toggle-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="p-2 border-bottom">
                <button id="new-chat-btn" class="rounded-md">
                    <i class="fas fa-plus"></i>
                    <span class="new-chat-text">Tạo cuộc trò chuyện mới</span>
                </button>
            </div>
            <div
                id="conversation-list-container"
                class="conversation-list-container"
            >
                <ul id="conversation-list" class="list-unstyled m-0">
                    <!-- Skeleton loading -->
                    <li class="skeleton skeleton-item"></li>
                    <li class="skeleton skeleton-item"></li>
                    <li class="skeleton skeleton-item"></li>
                </ul>
                <div
                    id="empty-conversations"
                    class="text-center p-4 text-muted hidden"
                >
                    <i class="fas fa-comments fs-4 mb-3"></i>
                    <p class="mb-0">Bạn chưa có cuộc trò chuyện nào</p>
                </div>
            </div>
        </div>

        <!-- Update the chat container structure -->
        <div id="main-content">
            <div class="chat-container">
                <div class="chat-card shadow-sm">
                    <!-- Header -->
                    <div class="chat-header text-white">
                        <div
                            class="d-flex align-items-center justify-content-between"
                        >
                            <div class="d-flex align-items-center">
                                <button
                                    id="mobile-toggle"
                                    class="btn btn-sm text-white me-3 d-md-none"
                                >
                                    <i class="fas fa-bars"></i>
                                </button>
                                <i class="fas fa-robot me-3 fs-4"></i>
                                <h5 class="mb-0">Chatbot Y Tế</h5>
                            </div>
                            <!-- <div class="d-flex gap-2">
                                <button
                                    id="back-to-home"
                                    class="btn btn-sm btn-outline-light px-3"
                                >
                                    <i class="fas fa-home me-2"></i> Trang chủ
                                </button>
                                <button
                                    id="clear-session"
                                    class="btn btn-sm btn-outline-light px-3"
                                >
                                    <i class="fas fa-trash me-2"></i> Xóa phiên
                                </button>
                            </div> -->
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div class="chat-messages-container">
                        <div id="chat-messages" class="h-100">
                            <!-- Messages will be added here -->
                            <div class="d-flex mb-3">
                                <div
                                    class="bg-info bg-opacity-10 p-3 rounded-3 shadow-sm"
                                    style="max-width: 80%"
                                >
                                    <div class="markdown-content mb-1">
                                        <p>
                                            Xin chào! Tôi là trợ lý y tế ảo của
                                            SmartClinic.AI.
                                        </p>
                                        <p>
                                            Tôi có thể giúp gì cho bạn hôm nay?
                                        </p>
                                        <p>Ví dụ:</p>
                                        <ul>
                                            <li>
                                                Tôi bị đau đầu và sốt. Đó có thể
                                                là triệu chứng của bệnh gì?
                                            </li>
                                            <li>
                                                Triệu chứng của bệnh tiểu đường
                                                là gì?
                                            </li>
                                            <li>
                                                Cách phòng ngừa bệnh tim mạch?
                                            </li>
                                        </ul>
                                    </div>
                                    <small class="text-muted">14:30</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="chat-footer">
                        <form id="chat-form" class="d-flex gap-3">
                            <input
                                type="text"
                                id="user-input"
                                class="form-control rounded-pill"
                                placeholder="Nhập tin nhắn của bạn..."
                            />
                            <button
                                type="submit"
                                class="btn btn-primary rounded-circle btn-send"
                            >
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script> -->
        <script src="../../static/bootstrap-5.3.6/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Config marked.js
            marked.setOptions({
                breaks: true, // Cho phép xuống dòng với một dấu xuống dòng
                gfm: true, // GitHub Flavored Markdown
                headerIds: false, // Không tạo ID cho headers
                sanitize: false, // Không sanitize HTML, nhưng phải cẩn thận với XSS
                highlight: function (code, lang) {
                    const language = hljs.getLanguage(lang)
                        ? lang
                        : "plaintext";
                    return hljs.highlight(code, { language }).value;
                },
            });

            // Kiểm tra xác thực người dùng trước khi cho phép sử dụng chatbot
            document.addEventListener("DOMContentLoaded", function () {
                if (!window.AuthGuard.isAuthenticated()) {
                    // Nếu không đăng nhập, chuyển hướng về trang đăng nhập
                    window.location.href =
                        "/core/auth/login.html?redirect=" +
                        encodeURIComponent(window.location.pathname);
                    return;
                }

                // Lấy thông tin người dùng để sử dụng trong chatbot
                const userInfo = window.AuthGuard.getUserInfo();
                if (userInfo) {
                    // Có thể sử dụng userInfo.userName, userInfo.email, userInfo.userId khi cần
                    console.log("Đã đăng nhập với tên:", userInfo.userName);

                    // Tải danh sách các cuộc trò chuyện
                    loadConversationList();
                }
            });

            // Back to home button event
            // document
            //     .getElementById("back-to-home")
            //     .addEventListener("click", function () {
            //         window.location.href = "/home/main.html";
            //     });

            // Replace toggle sidebar function
            document
                .getElementById("toggle-sidebar")
                .addEventListener("click", function () {
                    const sidebar = document.getElementById("sidebar");
                    const mainContent = document.getElementById("main-content");
                    const icon = this.querySelector("i");

                    if (window.innerWidth <= 768) {
                        sidebar.classList.toggle("show");
                        document
                            .getElementById("sidebar-overlay")
                            .classList.toggle("show");
                    } else {
                        sidebar.classList.toggle("collapsed");
                        mainContent.classList.toggle("expanded");

                        // Toggle icon
                        if (sidebar.classList.contains("collapsed")) {
                            icon.classList.replace(
                                "fa-chevron-left",
                                "fa-chevron-right"
                            );
                        } else {
                            icon.classList.replace(
                                "fa-chevron-right",
                                "fa-chevron-left"
                            );
                        }
                    }
                });

            // Add overlay click handler
            document
                .getElementById("sidebar-overlay")
                .addEventListener("click", function () {
                    const sidebar = document.getElementById("sidebar");
                    const overlay = document.getElementById("sidebar-overlay");
                    sidebar.classList.remove("show");
                    overlay.classList.remove("show");
                });

            // Update mobile toggle handler
            document
                .getElementById("mobile-toggle")
                .addEventListener("click", function () {
                    const sidebar = document.getElementById("sidebar");
                    const overlay = document.getElementById("sidebar-overlay");
                    sidebar.classList.toggle("show");
                    overlay.classList.toggle("show");
                });

            // Update window resize handler
            window.addEventListener("resize", function () {
                const sidebar = document.getElementById("sidebar");
                const mainContent = document.getElementById("main-content");
                const overlay = document.getElementById("sidebar-overlay");

                if (window.innerWidth > 768) {
                    overlay.classList.remove("show");
                    sidebar.classList.remove("show");
                    if (sidebar.classList.contains("collapsed")) {
                        mainContent.classList.add("expanded");
                    } else {
                        mainContent.classList.remove("expanded");
                    }
                } else {
                    mainContent.classList.remove("expanded");
                    sidebar.classList.remove("collapsed");
                }
            });

            // Function to generate a random ID
            function generateRandomId(prefix) {
                return prefix + Math.random().toString(36).substring(2, 9);
            }

            // Get or create session ID
            function getOrCreateSessionId(key, prefix) {
                // Try to get from localStorage
                let id = localStorage.getItem(key);

                // If not found, create a new one and store it
                if (!id) {
                    id = generateRandomId(prefix);
                    localStorage.setItem(key, id);
                }

                return id;
            }

            // Global variables
            const userInfo = window.AuthGuard.getUserInfo();
            const userId = userInfo
                ? userInfo.userId
                : generateRandomId("user-");
            let sessionId = getOrCreateSessionId(
                "medical_chatbot_session_id",
                "session-"
            );
            let currentConversationName = "Cuộc trò chuyện mới";
            const chatMessages = document.getElementById("chat-messages");
            const chatForm = document.getElementById("chat-form");
            const userInput = document.getElementById("user-input");
            const clearSessionBtn = document.getElementById("clear-session");
            const newChatBtn = document.getElementById("new-chat-btn");

            // Initialize
            userInput.focus();

            // Event listeners
            chatForm.addEventListener("submit", sendMessage);
            // clearSessionBtn.addEventListener("click", clearSession);
            newChatBtn.addEventListener("click", createNewChat);

            // Function to load conversation list
            async function loadConversationList() {
                try {
                    // Lấy token để gửi kèm request
                    const token = localStorage.getItem("accessToken");
                    const headers = {
                        accept: "application/json",
                    };

                    // Thêm token vào header nếu có
                    if (token) {
                        headers["Authorization"] = `Bearer ${token}`;
                    }

                    const response = await fetch(
                        `http://localhost:8000/chat_history/chat_sessions/${userId}`,
                        {
                            method: "GET",
                            headers: headers,
                        }
                    );

                    if (!response.ok) {
                        throw new Error("Failed to load conversations");
                    }

                    const conversations = await response.json();

                    // Xóa skeleton loading
                    const conversationList =
                        document.getElementById("conversation-list");
                    conversationList.innerHTML = "";

                    if (conversations.length === 0) {
                        // Hiển thị empty state
                        document
                            .getElementById("empty-conversations")
                            .classList.remove("hidden");
                    } else {
                        // Ẩn empty state
                        document
                            .getElementById("empty-conversations")
                            .classList.add("hidden");

                        // Hiển thị danh sách cuộc trò chuyện
                        conversations.forEach((conversation) => {
                            addConversationToList(conversation);
                        });

                        // Kiểm tra xem session hiện tại có trong danh sách không
                        const currentSession = conversations.find(
                            (conv) => conv.session_id === sessionId
                        );
                        if (currentSession) {
                            // Đánh dấu là active
                            const currentItem = document.querySelector(
                                `[data-session-id="${sessionId}"]`
                            );
                            if (currentItem) {
                                currentItem.classList.add("active");
                            }

                            // Tải lịch sử của phiên hiện tại
                            loadChatHistoryFromAPI(sessionId);
                        } else if (conversations.length > 0) {
                            // Nếu không có phiên hiện tại, dùng phiên đầu tiên
                            const firstConversation = conversations[0];
                            sessionId = firstConversation.session_id;
                            localStorage.setItem(
                                "medical_chatbot_session_id",
                                sessionId
                            );

                            const firstItem = document.querySelector(
                                `[data-session-id="${sessionId}"]`
                            );
                            if (firstItem) {
                                firstItem.classList.add("active");
                            }

                            // Tải lịch sử của phiên đầu tiên
                            loadChatHistoryFromAPI(sessionId);
                        }
                    }
                } catch (error) {
                    console.error("Error loading conversations:", error);
                    // Xóa skeleton loading và hiển thị lỗi
                    document.getElementById(
                        "conversation-list"
                    ).innerHTML = `<div class="p-3 text-danger">Không thể tải danh sách hội thoại</div>`;
                }
            }

            // Thêm cuộc trò chuyện vào danh sách
            function addConversationToList(conversation) {
                const conversationList =
                    document.getElementById("conversation-list");

                const listItem = document.createElement("li");
                listItem.className = "conversation-item";
                listItem.setAttribute(
                    "data-session-id",
                    conversation.session_id
                );

                // Định dạng thời gian
                const date = new Date(conversation.latest_timestamp);
                const formattedTime =
                    date.toLocaleDateString() +
                    " " +
                    date.toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                    });

                // HTML cho mỗi mục
                listItem.innerHTML = `
                    <div class="conversation-preview">
                        <div class="conversation-title text-truncate">
                            <i class="fas fa-message me-2 text-primary"></i>
                            ${conversation.conversation_name}
                        </div>
                        <div class="conversation-time">
                            <i class="fas fa-clock me-1"></i>${formattedTime}
                        </div>
                    </div>
                `;

                // Sự kiện khi click vào cuộc trò chuyện
                listItem.addEventListener("click", function () {
                    switchConversation(conversation.session_id);
                });

                conversationList.appendChild(listItem);
            }

            // Chuyển đổi cuộc trò chuyện
            function switchConversation(newSessionId) {
                // Đánh dấu active cho mục được chọn
                document
                    .querySelectorAll("[data-session-id]")
                    .forEach((item) => {
                        item.classList.remove("active");
                    });
                document
                    .querySelector(`[data-session-id="${newSessionId}"]`)
                    .classList.add("active");

                // Lưu session ID mới
                sessionId = newSessionId;
                localStorage.setItem("medical_chatbot_session_id", sessionId);

                // Tải lịch sử chat từ API
                loadChatHistoryFromAPI(sessionId);

                // Đóng sidebar trên mobile
                const sidebar = document.getElementById("sidebar");
                if (
                    window.innerWidth <= 768 &&
                    sidebar.classList.contains("translate-x-0")
                ) {
                    sidebar.classList.remove("translate-x-0");
                    sidebar.classList.add("-translate-x-full");
                }
            }

            // Tạo cuộc trò chuyện mới
            function createNewChat() {
                // Tạo session ID mới
                const newSessionId = generateRandomId("session-");
                sessionId = newSessionId;
                localStorage.setItem("medical_chatbot_session_id", sessionId);

                // Xóa lịch sử chat hiện tại
                chatMessages.innerHTML = `
                <div class="d-flex mb-3">
                    <div class="bg-info bg-opacity-10 p-3 rounded-3 shadow-sm" style="max-width: 80%">
                        <div class="markdown-content mb-1">
                            <p>Xin chào! Tôi là trợ lý y tế ảo của SmartClinic.AI.</p>
                            <p>Tôi có thể giúp gì cho bạn hôm nay?</p>
                            <p>Ví dụ:</p>
                            <ul>
                                <li>Tôi bị đau đầu và sốt. Đó có thể là triệu chứng của bệnh gì?</li>
                                <li>Triệu chứng của bệnh tiểu đường là gì?</li>
                                <li>Cách phòng ngừa bệnh tim mạch?</li>
                            </ul>
                        </div>
                        <small class="text-muted">${new Date().toLocaleTimeString(
                            [],
                            { hour: "2-digit", minute: "2-digit" }
                        )}</small>
                    </div>
                </div>
                `;

                // Đánh dấu tất cả các mục không active
                document
                    .querySelectorAll("[data-session-id]")
                    .forEach((item) => {
                        item.classList.remove("active");
                    });

                // Focus vào input
                userInput.focus();
            }

            // Function to load chat history from API
            async function loadChatHistoryFromAPI(sessionId) {
                try {
                    // Lấy token để gửi kèm request
                    const token = localStorage.getItem("accessToken");
                    const headers = {
                        accept: "application/json",
                    };

                    // Thêm token vào header nếu có
                    if (token) {
                        headers["Authorization"] = `Bearer ${token}`;
                    }

                    const response = await fetch(
                        `http://localhost:8000/chat_history/chat_history/${sessionId}`,
                        {
                            method: "GET",
                            headers: headers,
                        }
                    );

                    if (!response.ok) {
                        throw new Error("Failed to load chat history");
                    }

                    const messages = await response.json();

                    // Xóa nội dung chat hiện tại
                    chatMessages.innerHTML = "";

                    if (messages.length === 0) {
                        // Hiển thị tin nhắn chào mừng nếu không có lịch sử
                        chatMessages.innerHTML = `
                        <div class="d-flex mb-3">
                            <div class="bg-info bg-opacity-10 p-3 rounded-3 shadow-sm" style="max-width: 80%">
                                <div class="markdown-content mb-1">
                                    <p>Xin chào! Tôi là trợ lý y tế ảo của SmartClinic.AI.</p>
                                    <p>Tôi có thể giúp gì cho bạn hôm nay?</p>
                                    <p>Ví dụ:</p>
                                    <ul>
                                        <li>Tôi bị đau đầu và sốt. Đó có thể là triệu chứng của bệnh gì?</li>
                                        <li>Triệu chứng của bệnh tiểu đường là gì?</li>
                                        <li>Cách phòng ngừa bệnh tim mạch?</li>
                                    </ul>
                                </div>
                                <small class="text-muted">${new Date().toLocaleTimeString(
                                    [],
                                    { hour: "2-digit", minute: "2-digit" }
                                )}</small>
                            </div>
                        </div>
                        `;
                    } else {
                        // Hiển thị các tin nhắn từ lịch sử
                        messages.forEach((message) => {
                            const date = new Date(message.timestamp);
                            const formattedTime = date.toLocaleTimeString([], {
                                hour: "2-digit",
                                minute: "2-digit",
                            });

                            addMessage(
                                message.message,
                                message.sender === "user" ? "user" : "bot",
                                formattedTime,
                                false // Không lưu vào API
                            );
                        });
                    }

                    // Scroll to bottom
                    scrollToBottom();
                } catch (error) {
                    console.error(
                        "Error loading chat history from API:",
                        error
                    );
                    // Hiển thị thông báo lỗi
                    chatMessages.innerHTML = `
                    <div class="alert alert-danger m-3">
                        Không thể tải lịch sử trò chuyện. Vui lòng thử lại sau.
                    </div>
                    `;
                }
            }

            // Function to clear session
            function clearSession() {
                if (
                    confirm("Bạn có chắc chắn muốn xóa toàn bộ phiên chat này?")
                ) {
                    // Tạo một phiên chat mới
                    createNewChat();

                    // Tải lại danh sách cuộc trò chuyện
                    loadConversationList();
                }
            }

            // Function to send message
            async function sendMessage(e) {
                e.preventDefault();

                const message = userInput.value.trim();
                if (!message) return;

                // Clear input
                userInput.value = "";

                // Get current time
                const time = new Date().toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                });

                // Add user message to chat
                addMessage(message, "user", time);

                // Show typing indicator - Tạo và thêm vào DOM
                const typingIndicator = showTypingIndicator();

                // Scroll to bottom
                scrollToBottom();

                try {
                    // Send request to API
                    const response = await callChatAPI(message);

                    // Hide typing indicator TRƯỚC khi hiển thị phản hồi
                    if (typingIndicator) {
                        typingIndicator.remove(); // Xóa hoàn toàn khỏi DOM
                    }

                    // Add bot response to chat
                    if (
                        response &&
                        response.choice &&
                        response.choice.messages
                    ) {
                        const botMessage = response.choice.messages.find(
                            (msg) => msg.role === "assistant"
                        );
                        if (botMessage) {
                            // Use time from API response if available
                            const responseTime = response.time_at
                                ? new Date(response.time_at).toLocaleTimeString(
                                      [],
                                      { hour: "2-digit", minute: "2-digit" }
                                  )
                                : time;

                            addMessage(botMessage.content, "bot", responseTime);
                        }
                    }

                    // Tải lại danh sách cuộc trò chuyện sau khi gửi tin nhắn
                    loadConversationList();
                } catch (error) {
                    console.error("Error:", error);
                    // Hide typing indicator in case of error too
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }
                    addMessage(
                        "Xin lỗi, đã xảy ra lỗi khi xử lý yêu cầu của bạn.",
                        "bot",
                        time
                    );
                }

                // Scroll to bottom again after adding bot message
                scrollToBottom();
            }

            // Function to show typing indicator
            function showTypingIndicator() {
                const typingIndicator = document.createElement("div");
                typingIndicator.id = "typing-indicator";
                typingIndicator.className = "d-flex ms-2 mb-3";
                typingIndicator.innerHTML = `
                <div class="bg-info bg-opacity-10 p-2 rounded-3">
                    <div class="d-flex align-items-center">
                        <small class="text-muted me-2">Đang nhập</small>
                        <div class="spinner-grow spinner-grow-sm text-info" role="status" style="width: 0.5rem; height: 0.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="spinner-grow spinner-grow-sm text-info ms-1" role="status" style="width: 0.5rem; height: 0.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="spinner-grow spinner-grow-sm text-info ms-1" role="status" style="width: 0.5rem; height: 0.5rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            `;
                chatMessages.appendChild(typingIndicator);
                return typingIndicator;
            }

            // Function to parse Markdown to HTML
            function parseMarkdown(content) {
                // Replace code blocks with properly formatted HTML
                let parsedContent = marked.parse(content);

                // Initialize syntax highlighting
                document.querySelectorAll("pre code").forEach((block) => {
                    hljs.highlightBlock(block);
                });

                return parsedContent;
            }

            // Function to add message to chat
            function addMessage(content, role, time, saveToHistory = true) {
                const messageDiv = document.createElement("div");
                messageDiv.className = "d-flex mb-3";

                // Parse markdown content
                const parsedContent =
                    role === "bot" ? parseMarkdown(content) : content;

                if (role === "user") {
                    messageDiv.classList.add("justify-content-end");
                    messageDiv.innerHTML = `
                    <div class="bg-primary bg-opacity-10 p-3 rounded-3 shadow-sm" style="max-width: 80%;">
                        <p class="mb-0">${parsedContent}</p>
                        <small class="text-muted d-block text-end">${time}</small>
                    </div>
                `;
                } else {
                    messageDiv.innerHTML = `
                    <div class="bg-info bg-opacity-10 p-3 rounded-3 shadow-sm" style="max-width: 80%;">
                        <div class="markdown-content mb-1">${parsedContent}</div>
                        <small class="text-muted">${time}</small>
                    </div>
                `;
                }

                chatMessages.appendChild(messageDiv);

                // Apply syntax highlighting to newly added code blocks
                messageDiv.querySelectorAll("pre code").forEach((block) => {
                    hljs.highlightElement(block);
                });
            }

            // Function to call chat API
            async function callChatAPI(message) {
                // Lấy token để gửi kèm request (nếu cần xác thực API)
                const token = localStorage.getItem("accessToken");
                const headers = {
                    "Content-Type": "application/json",
                    accept: "application/json",
                };

                // Thêm token vào header nếu có
                if (token) {
                    headers["Authorization"] = `Bearer ${token}`;
                }

                // Lấy thông tin người dùng
                const userInfo = window.AuthGuard.getUserInfo();
                const actualUserId = userInfo ? userInfo.userId : userId;

                const response = await fetch(
                    "http://localhost:8000/chat_all/chat",
                    {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({
                            user_id: actualUserId,
                            session_id: sessionId,
                            conversation_name: currentConversationName,
                            messages: [
                                {
                                    role: "user",
                                    content: message,
                                },
                            ],
                        }),
                    }
                );

                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }

                return await response.json();
            }

            // Function to scroll chat to bottom
            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        </script>
    </body>
</html>
