<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <title>Chatbot Hỗ trợ Markdown</title>
        <!-- Thư viện marked để render markdown -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <style>
            body {
                margin: 0;
                padding: 0;
                background-color: #f5f5f5;
                font-family: Arial, sans-serif;
            }

            /* Khung tổng thể của chatbot */
            .chat-container {
                width: 100%;
                max-width: 600px;
                min-height: 600px;
                margin: 40px auto;
                background: #fff;
                display: flex;
                flex-direction: column;
                border: 1px solid #ddd;
                border-radius: 8px;
                overflow: hidden;
            }

            /* Phần tiêu đề (header) */
            .chat-header {
                background: #007bff;
                color: #fff;
                padding: 16px;
                text-align: center;
                font-size: 1.2em;
                font-weight: 500;
            }

            /* Khu vực hiển thị tin nhắn */
            .chat-messages {
                flex: 1;
                padding: 16px;
                overflow-y: auto;
                background-color: #fafafa;
            }

            /* Một "dòng" tin nhắn cụ thể */
            .message {
                clear: both;
                margin-bottom: 12px;
                display: block;
            }

            /* Khối hiển thị nội dung tin nhắn (bubble) */
            .bubble {
                display: inline-block;
                max-width: 80%;
                padding: 10px 14px;
                border-radius: 8px;
                word-wrap: break-word;
                font-size: 1em;
            }

            /* Tin nhắn của user (nằm bên phải) */
            .message.user .bubble {
                background: #dcf8c6;
                float: right;
                text-align: left;
            }

            /* Tin nhắn của bot (nằm bên trái) */
            .message.bot .bubble {
                background: #f1f0f0;
                float: left;
            }

            /* Khu vực nhập và gửi tin nhắn */
            .chat-input {
                display: flex;
                border-top: 1px solid #ddd;
                background-color: #fff;
                padding: 8px;
            }

            .chat-input textarea {
                flex: 1;
                resize: none;
                height: 48px;
                padding: 8px;
                font-size: 1em;
                border: 1px solid #ccc;
                border-radius: 4px;
                outline: none;
            }

            .chat-input button {
                margin-left: 8px;
                padding: 0 20px;
                font-size: 1em;
                border: none;
                border-radius: 4px;
                background-color: #007bff;
                color: #fff;
                cursor: pointer;
            }
            .chat-input button:hover {
                background-color: #0056b3;
            }
        </style>
    </head>
    <body>
        <div class="chat-container">
            <div class="chat-header">Chatbot Hỗ trợ Markdown</div>
            <div id="chatMessages" class="chat-messages">
                <!-- Tin nhắn sẽ được hiển thị tại đây -->
            </div>
            <div class="chat-input">
                <textarea
                    id="messageInput"
                    placeholder="Nhập tin nhắn của bạn vào đây..."
                ></textarea>
                <button id="sendButton">Gửi</button>
            </div>
        </div>

        <!-- Chỉ hiển thị phần thay đổi, phần <style> giữ nguyên nếu bạn đã có -->
        <script>
            const userId = "string";

            const chatMessagesEl = document.getElementById("chatMessages");
            const messageInputEl = document.getElementById("messageInput");
            const sendButtonEl = document.getElementById("sendButton");

            function appendMessage(role, content) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message", role);

                const bubbleDiv = document.createElement("div");
                bubbleDiv.classList.add("bubble");

                bubbleDiv.innerHTML = marked.parse(content);

                messageDiv.appendChild(bubbleDiv);
                chatMessagesEl.appendChild(messageDiv);
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            }

            async function sendMessage() {
                const messageContent = messageInputEl.value.trim();
                if (!messageContent) return;

                appendMessage("user", messageContent);

                messageInputEl.value = "";
                messageInputEl.focus();

                const payload = {
                    user_id: userId,
                    messages: [
                        {
                            role: "user",
                            content: messageContent,
                        },
                    ],
                };

                try {
                    const response = await fetch(
                        "http://localhost:8000/chat_all/chat",
                        {
                            method: "POST",
                            headers: {
                                accept: "application/json",
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(payload),
                        }
                    );

                    if (!response.ok) {
                        throw new Error("Không thể kết nối API");
                    }

                    const data = await response.json();

                    if (data && data.choice && data.choice.messages) {
                        const botMessages = data.choice.messages;
                        botMessages.forEach((msg) => {
                            if (
                                msg.role === "assistant" ||
                                msg.role === "bot"
                            ) {
                                appendMessage("bot", msg.content);
                            }
                        });
                    }
                } catch (error) {
                    console.error(error);
                    appendMessage("bot", "Đã có lỗi khi kết nối server.");
                }
            }

            sendButtonEl.addEventListener("click", sendMessage);

            messageInputEl.addEventListener("keydown", function (e) {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        </script>
    </body>
</html>
